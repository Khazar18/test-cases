# escape=`
FROM mcr.microsoft.com/windows/servercore:ltsc2022

# Set environment variables
ENV CHROME_URL=https://dl.google.com/chrome/install/latest/chrome_installer.exe
ENV CHROMEDRIVER_URL=https://storage.googleapis.com/chrome-for-testing-public/137.0.7151.119/win64/chromedriver-win64.zip
ENV SETUP_DIR=C:\test-setup
ENV VENV_DIR=C:\venv

# Install Python (You can replace this with another method if needed)
RUN powershell -Command `
    Invoke-WebRequest -Uri https://www.python.org/ftp/python/3.10.11/python-3.10.11-amd64.exe -OutFile python-installer.exe ; `
    Start-Process python-installer.exe -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1" -Wait ; `
    Remove-Item python-installer.exe

# Create directories
RUN mkdir %SETUP_DIR%

# Download and install Chrome
RUN powershell -Command `
    Invoke-WebRequest -Uri %CHROME_URL% -OutFile %SETUP_DIR%\chrome_installer.exe ; `
    Start-Process -FilePath %SETUP_DIR%\chrome_installer.exe -ArgumentList "/silent /install" -Wait ; `
    Remove-Item %SETUP_DIR%\chrome_installer.exe

# Download and extract ChromeDriver
RUN powershell -Command `
    Invoke-WebRequest -Uri %CHROMEDRIVER_URL% -OutFile %SETUP_DIR%\chromedriver.zip ; `
    Expand-Archive -Path %SETUP_DIR%\chromedriver.zip -DestinationPath %SETUP_DIR% -Force ; `
    Remove-Item %SETUP_DIR%\chromedriver.zip

# Set PATH for chromedriver
ENV PATH="%SETUP_DIR%\\chromedriver-win64;%PATH%"

# Create Python virtual environment and install dependencies
COPY . /tests
WORKDIR /tests

RUN cmd /c "python -m venv %VENV_DIR% && ^
    call %VENV_DIR%\\Scripts\\activate.bat && ^
    pip install --upgrade pip && ^
    pip install selenium pytest"

# Default command to run tests
CMD cmd /c "call %VENV_DIR%\\Scripts\\activate.bat && pytest testcases.py"
